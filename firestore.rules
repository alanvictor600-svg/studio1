rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    // Config global (o app lê em tempo real)
    match /configs/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    // Sorteios (o app lê em tempo real)
    match /draws/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    // Usuário (o app faz getDoc em /users/{uid})
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update, delete: if false; // saldo/alterações só no servidor (Admin)
    }

    // Lookup de username (no cadastro você usa /users_username_lookup/{username})
    match /users_username_lookup/{username} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // Bilhetes (o app faz query: where participants array-contains user.id)
    match /tickets/{ticketId} {
      allow read: if signedIn() && (request.auth.uid in resource.data.participants);
      allow create, update, delete: if false; // criação só via server action (Admin)
    }

    // Histórico vendedor (se o app usar)
    match /sellerHistory/{id} {
      allow read: if signedIn();
      allow write: if false;
    }

    match /adminHistory/{id} {
      allow read: if signedIn();
      allow write: if false;
    }
  }
}
